document.addEventListener('DOMContentLoaded', async ()=>{ const whoRes = await fetch('/auth/whoami'); if(whoRes.status!==200) return location.href='/login.html'; const who = await whoRes.json(); document.getElementById('avatarPreview').src = who.user.avatarPath || '/images/avatar_placeholder.png'; const res = await fetch('/blogs/api/list'); const posts = await res.json(); const my = posts.filter(p=>p.author.username===who.user.username); const feed = document.getElementById('feed'); feed.innerHTML=''; my.forEach(p=>{ const el = document.createElement('div'); el.className='post-card'; el.innerHTML = '<h4>'+ (p.title||'') +'</h4><small>'+ new Date(p.createdAt).toLocaleString() +'</small><div><a href="/edit.html?id='+p._id+'">Edit</a> <button data-id="'+p._id+'" class="del">Delete</button></div>'; feed.appendChild(el); }); document.querySelectorAll('.del').forEach(b=> b.addEventListener('click', async (e)=>{ const id = e.target.dataset.id; if(!confirm('Delete?')) return; const r = await fetch('/blogs/api/'+id, { method:'DELETE', credentials:'same-origin' }); const jr = await r.json(); if(jr.success) location.reload(); else alert('Delete failed'); })); document.getElementById('avatarForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const fd = new FormData(e.target); const r = await fetch('/auth/avatar', { method:'POST', body: fd, credentials:'same-origin' }); const j = await r.json(); if(j.success){ document.getElementById('avatarPreview').src = j.avatarPath; } else alert(j.error||'Upload failed'); }); });
